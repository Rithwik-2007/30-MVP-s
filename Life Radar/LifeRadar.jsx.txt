import React, { useState, useEffect, useMemo } from 'react';
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer } from 'recharts';
import { CheckCircle, Plus, RefreshCw, ChevronRight, Activity, Brain, Wallet, User, Zap, Map } from 'lucide-react';

// --- Constants & Config ---

const AXES = [
  { key: 'Skill', color: '#3b82f6', icon: Brain },       // Blue
  { key: 'Health', color: '#10b981', icon: Activity },   // Emerald
  { key: 'Discipline', color: '#f59e0b', icon: Zap },    // Amber
  { key: 'Social', color: '#ec4899', icon: User },       // Pink
  { key: 'Money', color: '#14b8a6', icon: Wallet },      // Teal
  { key: 'Direction', color: '#8b5cf6', icon: Map },     // Violet
];

const MAX_VAL = 10;

// --- Mock AI Task Database ---
// In a real app, this would be generated by an LLM based on the prompt below.
const TASK_TEMPLATES = {
  general: [
    { text: "Drink 2L of water", axis: "Health", value: 0.1, type: "daily" },
    { text: "Wake up at 7 AM", axis: "Discipline", value: 0.2, type: "daily" },
    { text: "Call a family member", axis: "Social", value: 0.3, type: "daily" },
    { text: "Track expenses for the day", axis: "Money", value: 0.1, type: "daily" },
  ],
  student: [
    { text: "Review lecture notes for 20m", axis: "Skill", value: 0.2, type: "daily" },
    { text: "Complete one assignment part", axis: "Direction", value: 0.3, type: "daily" },
    { text: "Organize desk/workspace", axis: "Discipline", value: 0.1, type: "daily" },
  ],
  working: [
    { text: "Network with one colleague", axis: "Social", value: 0.2, type: "daily" },
    { text: "Update resume/portfolio", axis: "Money", value: 0.5, type: "long" },
    { text: "Clear email inbox", axis: "Discipline", value: 0.2, type: "daily" },
  ],
  tech: [
    { text: "Code for 45 mins", axis: "Skill", value: 0.3, type: "daily" },
    { text: "Read 1 tech article", axis: "Skill", value: 0.1, type: "daily" },
    { text: "Build a small project feature", axis: "Skill", value: 0.4, type: "long" },
  ],
  writing: [
    { text: "Write 300 words", axis: "Skill", value: 0.2, type: "daily" },
    { text: "Edit a previous draft", axis: "Skill", value: 0.2, type: "daily" },
  ],
  fitness: [
    { text: "30 min workout", axis: "Health", value: 0.4, type: "daily" },
    { text: "Stretch for 10 mins", axis: "Health", value: 0.1, type: "daily" },
    { text: "Meal prep for tomorrow", axis: "Health", value: 0.3, type: "daily" },
  ],
  unemployed: [
    { text: "Send 3 job applications", axis: "Money", value: 0.4, type: "daily" },
    { text: "Update LinkedIn profile", axis: "Direction", value: 0.3, type: "long" },
    { text: "Learn a new market skill", axis: "Skill", value: 0.3, type: "long" },
  ],
};

// --- Helper Components ---

const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95";
  const variants = {
    primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-md",
    secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200",
    outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
    ghost: "text-slate-500 hover:bg-slate-100 hover:text-slate-900",
  };
  return (
    <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`} disabled={disabled}>
      {children}
    </button>
  );
};

const Card = ({ children, className = '' }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-100 p-6 ${className}`}>
    {children}
  </div>
);

// --- Main App Component ---

export default function LifeShapeApp() {
  const [view, setView] = useState('onboarding'); // 'onboarding' | 'dashboard'
  const [stats, setStats] = useState({
    Skill: 0, Health: 0, Discipline: 0, Social: 0, Money: 0, Direction: 0
  });
  const [tasks, setTasks] = useState([]);
  
  // Onboarding State
  const [userProfile, setUserProfile] = useState({
    situation: '',
    stage: '',
    interests: '',
    time: 30,
    painPoint: ''
  });

  // Load from local storage on mount (simulated persistence)
  useEffect(() => {
    const saved = localStorage.getItem('lifeShapeState');
    if (saved) {
      const parsed = JSON.parse(saved);
      setStats(parsed.stats);
      setTasks(parsed.tasks);
      setUserProfile(parsed.userProfile);
      if (parsed.userProfile.situation) setView('dashboard');
    }
  }, []);

  // Save to local storage on change
  useEffect(() => {
    if (view === 'dashboard') {
      localStorage.setItem('lifeShapeState', JSON.stringify({ stats, tasks, userProfile }));
    }
  }, [stats, tasks, userProfile, view]);

  // --- Logic: Mock AI Task Generator ---
  
  const generateTasks = () => {
    let pool = [...TASK_TEMPLATES.general];

    // Situation based
    if (userProfile.situation === 'student') pool = [...pool, ...TASK_TEMPLATES.student];
    if (userProfile.situation === 'working') pool = [...pool, ...TASK_TEMPLATES.working];
    if (userProfile.situation === 'unemployed') pool = [...pool, ...TASK_TEMPLATES.unemployed];

    // Interest based (simple keyword matching)
    const interests = userProfile.interests.toLowerCase();
    if (interests.includes('tech') || interests.includes('code')) pool = [...pool, ...TASK_TEMPLATES.tech];
    if (interests.includes('fit') || interests.includes('gym')) pool = [...pool, ...TASK_TEMPLATES.fitness];
    if (interests.includes('write')) pool = [...pool, ...TASK_TEMPLATES.writing];

    // Select random tasks: 3 daily, 1 long-term
    const newTasks = [];
    const usedIndices = new Set();
    
    // Attempt to fill daily
    while (newTasks.filter(t => t.type === 'daily').length < 3 && usedIndices.size < pool.length) {
      const idx = Math.floor(Math.random() * pool.length);
      if (!usedIndices.has(idx)) {
        usedIndices.add(idx);
        if (pool[idx].type === 'daily' || !pool[idx].type) { // default to daily
          newTasks.push({ ...pool[idx], id: Date.now() + Math.random(), completed: false });
        }
      }
    }

    // Attempt to fill long term
    const longTermPool = pool.filter(t => t.type === 'long');
    if (longTermPool.length > 0) {
       const lt = longTermPool[Math.floor(Math.random() * longTermPool.length)];
       newTasks.push({ ...lt, id: Date.now() + Math.random(), completed: false });
    } else {
        // Fallback if no specific long term tasks found
        newTasks.push({ text: `Deep dive into ${userProfile.interests || 'a topic'}`, axis: 'Skill', value: 0.5, type: 'long', id: Date.now() + Math.random() });
    }

    setTasks(newTasks);
  };

  const completeTask = (task) => {
    // 1. Update Stats
    setStats(prev => {
      const currentVal = prev[task.axis];
      const newVal = Math.min(currentVal + task.value, MAX_VAL); // Cap at 10
      return { ...prev, [task.axis]: parseFloat(newVal.toFixed(2)) };
    });

    // 2. Remove Task
    setTasks(prev => prev.filter(t => t.id !== task.id));
  };

  // --- Chart Data Formatter ---
  const chartData = useMemo(() => {
    return AXES.map(axis => ({
      subject: axis.key,
      A: stats[axis.key],
      fullMark: MAX_VAL,
    }));
  }, [stats]);


  // --- Views ---

  if (view === 'onboarding') {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans text-slate-800">
        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
          <div className="mb-8 text-center">
            <h1 className="text-3xl font-bold text-slate-900 tracking-tight">Life Shape</h1>
            <p className="text-slate-500 mt-2">Build your progress from zero.</p>
          </div>

          <div className="space-y-6">
            <div>
              <label className="block text-sm font-semibold mb-2">Current Situation</label>
              <select 
                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                value={userProfile.situation}
                onChange={(e) => setUserProfile({...userProfile, situation: e.target.value})}
              >
                <option value="">Select...</option>
                <option value="student">Student</option>
                <option value="working">Working Professional</option>
                <option value="unemployed">Seeking Opportunities</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2">Current Stage / Year</label>
              <input 
                type="text" 
                placeholder="e.g., 2nd Year College, Junior Dev"
                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                value={userProfile.stage}
                onChange={(e) => setUserProfile({...userProfile, stage: e.target.value})}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2">Interests (comma separated)</label>
              <input 
                type="text" 
                placeholder="e.g., tech, fitness, history"
                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                value={userProfile.interests}
                onChange={(e) => setUserProfile({...userProfile, interests: e.target.value})}
              />
            </div>

             <div>
              <label className="block text-sm font-semibold mb-2">Time Available (mins/day)</label>
              <div className="flex items-center gap-4">
                <input 
                  type="range" min="15" max="240" step="15"
                  className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                  value={userProfile.time}
                  onChange={(e) => setUserProfile({...userProfile, time: parseInt(e.target.value)})}
                />
                <span className="text-sm font-mono w-16 text-right">{userProfile.time}m</span>
              </div>
            </div>

             <div>
              <label className="block text-sm font-semibold mb-2">Biggest Pain Point</label>
              <input 
                type="text" 
                placeholder="e.g., Procrastination, No Direction"
                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                value={userProfile.painPoint}
                onChange={(e) => setUserProfile({...userProfile, painPoint: e.target.value})}
              />
            </div>

            <Button 
              className="w-full py-4 text-lg mt-4" 
              onClick={() => {
                if(userProfile.situation) {
                  generateTasks();
                  setView('dashboard');
                }
              }}
              disabled={!userProfile.situation}
            >
              Start Building <ChevronRight size={20} />
            </Button>
          </div>
        </div>
      </div>
    );
  }

  // Dashboard View
  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
      
      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center">
              <div className="w-4 h-4 border-2 border-white transform rotate-45"></div>
            </div>
            <h1 className="font-bold text-xl tracking-tight text-slate-900">Life Shape</h1>
          </div>
          <Button variant="ghost" onClick={() => {
            // Reset for demo purposes
            if(confirm("Reset all progress? This cannot be undone.")) {
              localStorage.clear();
              window.location.reload();
            }
          }}>
            Reset
          </Button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        
        {/* Left Column: Visualization */}
        <div className="space-y-6">
          <Card className="h-[400px] flex flex-col items-center justify-center relative overflow-hidden">
            <h2 className="absolute top-6 left-6 font-bold text-slate-400 text-sm uppercase tracking-wider">Your Shape</h2>
            
            {/* The Radar Chart */}
            <div className="w-full h-full -ml-4">
              <ResponsiveContainer width="100%" height="100%">
                <RadarChart cx="50%" cy="50%" outerRadius="70%" data={chartData}>
                  <PolarGrid stroke="#e2e8f0" />
                  <PolarAngleAxis 
                    dataKey="subject" 
                    tick={{ fill: '#64748b', fontSize: 12, fontWeight: 600 }} 
                  />
                  <PolarRadiusAxis angle={30} domain={[0, 10]} tick={false} axisLine={false} />
                  <Radar
                    name="Life"
                    dataKey="A"
                    stroke="#0f172a"
                    strokeWidth={3}
                    fill="#3b82f6"
                    fillOpacity={0.4}
                    isAnimationActive={true}
                  />
                </RadarChart>
              </ResponsiveContainer>
            </div>
            
            <div className="absolute bottom-6 w-full text-center">
               <span className="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded-full border border-slate-100">
                 Stats cap at 10.0
               </span>
            </div>
          </Card>

          {/* Stats Breakdown (Mobile/Detail view) */}
          <div className="grid grid-cols-3 gap-3">
             {AXES.map(axis => (
               <div key={axis.key} className="bg-white p-3 rounded-lg border border-slate-100 flex flex-col items-center justify-center shadow-sm">
                 <axis.icon size={16} className="mb-2" style={{color: axis.color}}/>
                 <span className="text-xs font-semibold text-slate-500 uppercase">{axis.key}</span>
                 <span className="text-lg font-bold text-slate-800">{stats[axis.key].toFixed(1)}</span>
               </div>
             ))}
          </div>
        </div>

        {/* Right Column: Actions */}
        <div className="space-y-6">
          
          {/* Action Header */}
          <div className="flex justify-between items-end">
            <div>
              <h2 className="text-xl font-bold text-slate-900">Available Tasks</h2>
              <p className="text-slate-500 text-sm mt-1">
                Completed tasks shape your chart immediately.
              </p>
            </div>
            <Button variant="outline" onClick={generateTasks} className="text-xs h-8">
              <RefreshCw size={14} /> Refresh AI
            </Button>
          </div>

          {/* Empty State */}
          {tasks.length === 0 && (
            <div className="bg-slate-100 rounded-xl p-8 text-center border border-dashed border-slate-300">
              <p className="text-slate-500 mb-4">No active tasks.</p>
              <Button onClick={generateTasks}>Generate For Today</Button>
            </div>
          )}

          {/* Task List */}
          <div className="space-y-3">
            {tasks.map((task) => {
              const axisInfo = AXES.find(a => a.key === task.axis);
              return (
                <div 
                  key={task.id} 
                  className="group bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-between"
                >
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full bg-slate-100 text-slate-600`}>
                        {task.type === 'long' ? 'Long-Term' : 'Daily'}
                      </span>
                      <span 
                        className="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full text-white"
                        style={{ backgroundColor: axisInfo?.color || '#94a3b8' }}
                      >
                        {task.axis} +{task.value}
                      </span>
                    </div>
                    <p className="text-slate-800 font-medium leading-snug">{task.text}</p>
                  </div>

                  <button 
                    onClick={() => completeTask(task)}
                    className="ml-4 w-10 h-10 rounded-full border-2 border-slate-200 flex items-center justify-center text-slate-300 hover:border-emerald-500 hover:text-emerald-500 hover:bg-emerald-50 transition-colors"
                  >
                    <CheckCircle size={20} strokeWidth={2.5} />
                  </button>
                </div>
              );
            })}
          </div>

          {/* Developer Note for Prompt */}
          <div className="mt-8 p-4 bg-slate-900 text-slate-300 rounded-lg text-xs font-mono opacity-80">
            <p className="font-bold text-white mb-2 uppercase">Dev Note: Backend AI Logic</p>
            <p className="mb-2">In a production build, the "Refresh AI" button would send this prompt to an LLM:</p>
            <div className="bg-black p-3 rounded border border-slate-700 text-emerald-400 whitespace-pre-wrap">
{`"User Profile: [${userProfile.situation}, ${userProfile.interests}, ${userProfile.time} mins/day].
Generate 4 specific, actionable tasks.
- 3 small daily tasks (< ${userProfile.time} mins).
- 1 long-term milestone task.
Map each strictly to one of: Skill, Health, Discipline, Social, Money, Direction.
Assign a value (0.1 - 0.5) based on difficulty.
Output JSON."`}
            </div>
          </div>

        </div>
      </main>
    </div>
  );
}