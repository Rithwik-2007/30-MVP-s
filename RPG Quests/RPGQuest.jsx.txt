import React, { useState, useEffect, useRef } from 'react';
import { Loader2, Map, CheckCircle, Navigation, Award, Footprints, Flame, Trophy, X, Sparkles, Plus, Menu, Wand2, Scroll, BookOpen } from 'lucide-react';

/**
 * QuestMap Application (AI-Enhanced & Robust)
 * * A gamified to-do list that places tasks on a map.
 * * Uses Gemini API to act as a "Dungeon Master".
 * * FEATURES ADDED:
 * * 1. Oracle's Breakdown: Uses Gemini to split big tasks into sub-quests.
 * * 2. Bard's Chronicles: Uses Gemini to write a story based on completed tasks.
 */

const QuestMap = () => {
  // --- State ---
  const [quests, setQuests] = useState([]);
  const [newTask, setNewTask] = useState('');
  const [userLevel, setUserLevel] = useState(1);
  const [xp, setXp] = useState(0);
  const [stats, setStats] = useState({ steps: 0, calories: 0, distanceKm: 0 });
  const [achievements, setAchievements] = useState([]);
  const [showAchievement, setShowAchievement] = useState(null);
  const [mapLoaded, setMapLoaded] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  
  // New State for Chronicle Feature
  const [chronicle, setChronicle] = useState(null);
  const [showChronicleModal, setShowChronicleModal] = useState(false);
  const [isWritingLegend, setIsWritingLegend] = useState(false);

  // Constants
  const XP_TO_LEVEL = 1000;
  const STEPS_PER_KM = 1312;
  const CALORIES_PER_STEP = 0.04;
  const START_LOCATION = { lat: 40.7128, lng: -74.0060 }; // NYC Default for demo

  // Refs for Map
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const markersRef = useRef({});
  const routeLineRef = useRef(null);
  const leafletLoaded = useRef(false);

  // --- Map Initialization ---
  useEffect(() => {
    if (leafletLoaded.current) return;

    const loadLeaflet = async () => {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);

      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.async = true;
      
      script.onload = () => {
        leafletLoaded.current = true;
        setTimeout(() => {
          initMap();
          setMapLoaded(true);
        }, 100);
      };

      script.onerror = () => {
        console.error("Leaflet failed to load");
        setMapLoaded(true); 
      };

      document.body.appendChild(script);
    };

    loadLeaflet();
  }, []);

  const initMap = () => {
    const mapContainer = document.getElementById('quest-map');
    if (!window.L || mapInstanceRef.current || !mapContainer) return;

    try {
      const map = window.L.map('quest-map').setView([START_LOCATION.lat, START_LOCATION.lng], 14);
      
      window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      const userIcon = window.L.divIcon({
        className: 'bg-blue-600 rounded-full border-2 border-white shadow-lg',
        iconSize: [20, 20],
      });
      window.L.marker([START_LOCATION.lat, START_LOCATION.lng], { icon: userIcon })
        .addTo(map)
        .bindPopup("You are here");

      mapInstanceRef.current = map;
    } catch (err) {
      console.error("Error initializing map:", err);
    }
  };

  // --- AI Interactions ---

  const callGemini = async (prompt) => {
    const apiKey = ""; // Injected by runtime
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    if (!apiKey) throw new Error("No API Key");

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json" }
      })
    });

    if (!response.ok) throw new Error("AI Request Failed");

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    return JSON.parse(text);
  };

  // 1. Dungeon Master (Task -> Epic Quest)
  const generateQuestDetails = async (taskText) => {
    const prompt = `
      Act as an RPG Dungeon Master. Transform this real-world task: "${taskText}" into an epic fantasy quest.
      Return ONLY a raw JSON object with these properties:
      - "title": A short, epic fantasy name for the task.
      - "description": A 1-sentence flavor text description.
      - "xp": An integer between 100 and 500 representing the difficulty/effort.
    `;
    
    try {
      return await callGemini(prompt);
    } catch (error) {
      console.log("Using fallback quest generation.");
      return {
        title: taskText,
        description: "A standard mission for the adventurer.",
        xp: 100 + Math.floor(Math.random() * 100)
      };
    }
  };

  // 2. Oracle's Breakdown (Quest -> Sub-quests)
  const breakDownQuest = async (questId) => {
    const parentQuest = quests.find(q => q.id === questId);
    if (!parentQuest) return;

    setIsGenerating(true);

    const prompt = `
      Act as a tactical RPG advisor. The hero has a main quest: "${parentQuest.originalTask}".
      Break this down into 2 or 3 smaller, concrete steps/sub-quests.
      Return ONLY a raw JSON object containing an array "subquests". Each item in the array must have:
      - "originalTask": The practical step name.
      - "title": A fantasy name for the step.
      - "description": A short flavor text.
      - "xp": Integer (50-150).
    `;

    try {
      const result = await callGemini(prompt);
      
      if (result && result.subquests) {
        // Generate locations for new subquests near the parent
        const newQuests = result.subquests.map((sq, index) => {
          const latOffset = (Math.random() - 0.5) * 0.01; 
          const lngOffset = (Math.random() - 0.5) * 0.01;
          return {
            id: Date.now() + index,
            originalTask: sq.originalTask,
            title: sq.title,
            description: sq.description,
            lat: parentQuest.lat + latOffset,
            lng: parentQuest.lng + lngOffset,
            status: 'active',
            rewardXp: sq.xp
          };
        });

        // Add new quests and remove the old "big" quest to avoid duplication?
        // Let's keep the old one but mark it as 'broken down' or just remove it.
        // For gameplay flow, replacing it feels best.
        const updatedQuests = quests.filter(q => q.id !== questId).concat(newQuests);
        
        setQuests(updatedQuests);
        updateMapMarkers(updatedQuests);
        calculateBestPath(updatedQuests);
        unlockAchievement("Tactician", "Consulted the Oracle to plan your moves.", "bg-indigo-500");
      }
    } catch (err) {
      console.error("Breakdown failed", err);
    } finally {
      setIsGenerating(false);
    }
  };

  // 3. Bard's Chronicle (Completed Quests -> Story)
  const generateLegend = async () => {
    const completed = quests.filter(q => q.status === 'completed');
    if (completed.length === 0) return;

    setIsWritingLegend(true);
    setShowChronicleModal(true);
    setChronicle(null);

    const taskList = completed.map(q => q.title).join(", ");
    const prompt = `
      Act as a medieval Bard. Write a short, epic paragraph (max 100 words) chronicling the hero's recent victories: ${taskList}.
      Use flowery, triumphant language.
      Return ONLY a raw JSON object with one property: "story".
    `;

    try {
      const result = await callGemini(prompt);
      setChronicle(result.story);
    } catch (err) {
      setChronicle("The Bard is currently out for lunch. (AI generation failed)");
    } finally {
      setIsWritingLegend(false);
    }
  };

  // --- Quest Management ---

  const addQuest = async (e) => {
    e.preventDefault();
    if (!newTask.trim()) return;

    setIsGenerating(true);

    try {
      const aiDetails = await generateQuestDetails(newTask);

      const latOffset = (Math.random() - 0.5) * 0.02; 
      const lngOffset = (Math.random() - 0.5) * 0.02;
      
      const questLocation = {
        id: Date.now(),
        originalTask: newTask,
        title: aiDetails.title || newTask,
        description: aiDetails.description || "A new task awaits.",
        lat: START_LOCATION.lat + latOffset,
        lng: START_LOCATION.lng + lngOffset,
        status: 'active',
        rewardXp: aiDetails.xp || 100
      };

      const updatedQuests = [...quests, questLocation];
      setQuests(updatedQuests);
      setNewTask('');
      
      updateMapMarkers(updatedQuests);
      calculateBestPath(updatedQuests);
      
      if (updatedQuests.length === 1) {
        unlockAchievement("The Journey Begins", "Accepted your first quest.", "bg-green-500");
      }
    } catch (err) {
      console.error("Failed to add quest:", err);
    } finally {
      setIsGenerating(false);
    }
  };

  const completeQuest = (id) => {
    const quest = quests.find(q => q.id === id);
    if (!quest || quest.status === 'completed') return;

    const updatedQuests = quests.map(q => 
      q.id === id ? { ...q, status: 'completed' } : q
    );
    setQuests(updatedQuests);

    const newXp = xp + quest.rewardXp;
    let newLevel = userLevel;
    if (newXp >= XP_TO_LEVEL * userLevel) {
      newLevel += 1;
      unlockAchievement("Level Up!", `You are now Level ${newLevel}!`, "bg-yellow-500");
    }
    setXp(newXp);
    setUserLevel(newLevel);

    const dist = calculateDistance(START_LOCATION.lat, START_LOCATION.lng, quest.lat, quest.lng);
    const addedSteps = Math.floor(dist * STEPS_PER_KM);
    const addedCals = Math.floor(addedSteps * CALORIES_PER_STEP);

    setStats(prev => ({
      steps: prev.steps + addedSteps,
      calories: prev.calories + addedCals,
      distanceKm: +(prev.distanceKm + dist).toFixed(2)
    }));

    updateMapMarkers(updatedQuests);

    if (stats.steps + addedSteps > 5000) {
      unlockAchievement("Marathoner", "Walked over 5000 steps!", "bg-purple-500");
    }
  };

  // --- Map & Pathfinding Helpers ---

  const updateMapMarkers = (currentQuests) => {
    if (!mapInstanceRef.current || !window.L) return;

    Object.values(markersRef.current).forEach(marker => marker.remove());
    markersRef.current = {};

    currentQuests.forEach(quest => {
      const isCompleted = quest.status === 'completed';
      const color = isCompleted ? '#10B981' : '#EF4444'; // Green or Red
      
      const icon = window.L.divIcon({
        className: 'custom-div-icon',
        html: `<div style="background-color: ${color}; width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">${isCompleted ? '✓' : '⚔️'}</div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });

      const popupContent = `
        <div style="font-family: sans-serif; text-align: center; min-width: 200px;">
          <h3 style="margin: 0; color: #1e293b; font-weight: bold;">${quest.title}</h3>
          <p style="margin: 4px 0; font-size: 12px; color: #64748b; font-style: italic;">"${quest.description}"</p>
          <div style="margin: 8px 0; font-weight: bold; color: #d97706;">Reward: ${quest.rewardXp} XP</div>
          ${!isCompleted ? 
            `<button 
              onclick="document.dispatchEvent(new CustomEvent('complete-quest', {detail: ${quest.id}}))"
              style="background-color: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; width: 100%;"
            >
              Complete Quest
            </button>` 
            : '<div style="color: #10b981; font-weight: bold;">Quest Complete</div>'
          }
        </div>
      `;

      const marker = window.L.marker([quest.lat, quest.lng], { icon })
        .addTo(mapInstanceRef.current)
        .bindPopup(popupContent);
      
      markersRef.current[quest.id] = marker;
    });

    if (currentQuests.length > 0) {
      try {
        const group = window.L.featureGroup(Object.values(markersRef.current));
        mapInstanceRef.current.fitBounds(group.getBounds().pad(0.2));
      } catch (e) {}
    }
  };

  useEffect(() => {
    const handleComplete = (e) => completeQuest(e.detail);
    document.addEventListener('complete-quest', handleComplete);
    return () => document.removeEventListener('complete-quest', handleComplete);
  }, [quests, xp, userLevel, stats]); 

  const calculateBestPath = (currentQuests) => {
    if (!mapInstanceRef.current || !window.L || currentQuests.length < 1) return;

    if (routeLineRef.current) routeLineRef.current.remove();

    const activeQuests = currentQuests.filter(q => q.status === 'active');
    if (activeQuests.length === 0) return;

    let path = [];
    let currentPos = START_LOCATION;
    let pool = [...activeQuests];

    path.push([START_LOCATION.lat, START_LOCATION.lng]);

    while (pool.length > 0) {
      let nearest = null;
      let minDist = Infinity;
      let nearestIndex = -1;

      pool.forEach((q, index) => {
        const d = calculateDistance(currentPos.lat, currentPos.lng, q.lat, q.lng);
        if (d < minDist) {
          minDist = d;
          nearest = q;
          nearestIndex = index;
        }
      });

      if (nearest) {
        path.push([nearest.lat, nearest.lng]);
        currentPos = { lat: nearest.lat, lng: nearest.lng };
        pool.splice(nearestIndex, 1);
      }
    }

    routeLineRef.current = window.L.polyline(path, {
      color: '#3B82F6',
      weight: 4,
      opacity: 0.7,
      dashArray: '10, 10'
    }).addTo(mapInstanceRef.current);
  };

  const calculateDistance = (lat1, lon1, lat2, lon2) => {
    const R = 6371; 
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c; 
  };

  const deg2rad = (deg) => deg * (Math.PI/180);

  const unlockAchievement = (title, desc, colorClass) => {
    if (achievements.includes(title)) return;
    setAchievements(prev => [...prev, title]);
    setShowAchievement({ title, desc, colorClass });
    setTimeout(() => setShowAchievement(null), 4000);
  };

  // --- Render ---

  return (
    <div className="flex flex-col h-screen bg-slate-900 text-slate-100 overflow-hidden font-sans">
      
      {/* Top HUD */}
      <div className="bg-slate-800 border-b border-slate-700 p-4 shadow-lg z-20">
        <div className="flex justify-between items-center max-w-6xl mx-auto">
          <div className="flex items-center space-x-4">
            <button 
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              className="md:hidden text-slate-300 hover:text-white"
            >
              <Menu className="w-6 h-6" />
            </button>

            <div className="relative">
              <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-xl font-bold border-2 border-slate-400">
                {userLevel}
              </div>
              <div className="absolute -bottom-1 -right-1 bg-yellow-500 text-xs text-black font-bold px-1.5 py-0.5 rounded-full">
                LVL
              </div>
            </div>
            <div>
              <h1 className="text-xl font-bold text-white flex items-center gap-2">
                QuestMap <Sparkles className="w-4 h-4 text-yellow-400" />
              </h1>
              <div className="w-32 h-2 bg-slate-700 rounded-full mt-1 overflow-hidden">
                <div 
                  className="h-full bg-yellow-500 transition-all duration-500"
                  style={{ width: `${(xp % XP_TO_LEVEL) / 10}%` }}
                />
              </div>
              <p className="text-xs text-slate-400 mt-1">{xp} XP / {userLevel * XP_TO_LEVEL} XP</p>
            </div>
          </div>

          <div className="flex space-x-6 text-sm items-center">
            {/* Legend Button */}
            <button 
              onClick={generateLegend}
              disabled={quests.filter(q => q.status === 'completed').length === 0}
              className="hidden sm:flex items-center gap-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed px-3 py-1.5 rounded-lg border border-slate-600 transition-colors"
              title="Generate Chronicle of Completed Quests"
            >
               <Scroll className="w-4 h-4 text-yellow-400" /> 
               <span>Chronicles</span>
            </button>

            <div className="flex flex-col items-center">
              <span className="text-slate-400 flex items-center gap-1"><Footprints className="w-4 h-4" /> Steps</span>
              <span className="font-bold text-lg">{stats.steps}</span>
            </div>
            <div className="flex flex-col items-center hidden sm:flex">
              <span className="text-slate-400 flex items-center gap-1"><Flame className="w-4 h-4 text-orange-500" /> Cals</span>
              <span className="font-bold text-lg">{stats.calories}</span>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="flex flex-1 relative overflow-hidden">
        
        {/* Quest Log Sidebar */}
        <div className={`
          w-80 bg-slate-800/95 backdrop-blur border-r border-slate-700 flex flex-col 
          absolute z-30 h-full transition-transform duration-300 ease-in-out
          md:relative md:translate-x-0
          ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}
        `}>
          <div className="p-4 border-b border-slate-700 flex justify-between items-center">
            <h2 className="font-bold text-lg flex items-center gap-2">
              <Award className="w-5 h-5 text-yellow-500" /> Quest Log
            </h2>
            <button onClick={() => setMobileMenuOpen(false)} className="md:hidden text-slate-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="p-4 border-b border-slate-700">
            <form onSubmit={addQuest} className="relative">
              <input 
                type="text" 
                value={newTask}
                onChange={(e) => setNewTask(e.target.value)}
                placeholder="Enter task (e.g., Clean House)"
                className="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 pl-3 pr-10 text-sm focus:outline-none focus:border-blue-500 transition-colors text-white"
                disabled={isGenerating}
              />
              <button 
                type="submit"
                disabled={!newTask.trim() || isGenerating}
                className="absolute right-2 top-1.5 text-blue-400 hover:text-blue-300 disabled:opacity-50"
              >
                {isGenerating ? <Loader2 className="w-5 h-5 animate-spin" /> : <Plus className="w-5 h-5" />}
              </button>
            </form>
            {isGenerating && <p className="text-xs text-blue-400 mt-2 italic animate-pulse">Consulting the Dungeon Master...</p>}
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-3">
            {quests.length === 0 && (
              <div className="text-center text-slate-500 mt-10">
                <p>No active quests.</p>
                <p className="text-sm">Add a task to begin your adventure!</p>
              </div>
            )}
            {quests.map(quest => (
              <div 
                key={quest.id} 
                className={`p-3 rounded-lg border ${quest.status === 'completed' ? 'bg-slate-900/50 border-slate-800 opacity-60' : 'bg-slate-700 border-slate-600 hover:border-slate-500'} transition-all group`}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <h3 className={`font-bold text-sm ${quest.status === 'completed' ? 'line-through text-slate-500' : 'text-white'}`}>
                      {quest.title}
                    </h3>
                    <p className="text-xs text-slate-400 italic mt-1">{quest.description}</p>
                    <p className="text-xs text-yellow-500 font-bold mt-1">+{quest.rewardXp} XP</p>
                  </div>
                  
                  <div className="flex items-center gap-1">
                    {/* Breakdown Button (Oracle) */}
                    {quest.status === 'active' && !isGenerating && (
                      <button 
                        onClick={() => breakDownQuest(quest.id)}
                        className="p-1 text-slate-400 hover:text-purple-400 transition-colors rounded hover:bg-slate-600"
                        title="Consult Oracle (Breakdown Task) ✨"
                      >
                        <Wand2 className="w-4 h-4" />
                      </button>
                    )}

                    {/* Complete Button */}
                    {quest.status === 'active' && (
                      <button 
                        onClick={() => completeQuest(quest.id)}
                        className="p-1 text-slate-400 hover:text-green-500 transition-colors rounded hover:bg-slate-600"
                        title="Complete Quest"
                      >
                        <CheckCircle className="w-5 h-5" />
                      </button>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Map Container */}
        <div id="quest-map" className="flex-1 bg-slate-200 relative z-10">
           {!mapLoaded && (
             <div className="absolute inset-0 flex items-center justify-center bg-slate-900 text-white z-20">
               <div className="text-center">
                 <Loader2 className="w-10 h-10 animate-spin mx-auto mb-4 text-blue-500" />
                 <p>Loading World Map...</p>
                 <p className="text-xs text-slate-500 mt-2">If this takes too long, you can still add quests.</p>
               </div>
             </div>
           )}
        </div>

        {/* Legend Modal (The Bard) */}
        {showChronicleModal && (
          <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div className="bg-[#f5e6d3] text-slate-900 max-w-lg w-full rounded-lg shadow-2xl p-6 relative border-4 border-[#8b4513]">
              <button 
                onClick={() => setShowChronicleModal(false)}
                className="absolute top-2 right-2 text-[#8b4513] hover:text-red-600"
              >
                <X className="w-6 h-6" />
              </button>
              
              <div className="text-center mb-6">
                <h2 className="text-2xl font-serif font-bold text-[#8b4513] flex items-center justify-center gap-2">
                  <BookOpen className="w-6 h-6" /> The Hero's Chronicle
                </h2>
                <div className="h-1 w-full bg-[#8b4513] mt-2 opacity-50"></div>
              </div>

              {isWritingLegend ? (
                <div className="flex flex-col items-center justify-center py-8">
                  <Loader2 className="w-8 h-8 animate-spin text-[#8b4513] mb-4" />
                  <p className="font-serif italic text-lg">The Bard is composing your ballad...</p>
                </div>
              ) : (
                <div className="prose prose-amber max-w-none">
                  <p className="font-serif text-lg leading-relaxed italic text-justify">
                    {chronicle}
                  </p>
                </div>
              )}

              <div className="mt-6 text-center">
                <p className="text-xs text-[#8b4513] opacity-70 uppercase tracking-widest">Recorded for Eternity</p>
              </div>
            </div>
          </div>
        )}

        {/* Achievement Popup */}
        {showAchievement && (
          <div className="absolute bottom-8 right-8 z-[1000] animate-bounce-in">
            <div className={`${showAchievement.colorClass} text-white p-4 rounded-lg shadow-xl flex items-center gap-4 min-w-[300px]`}>
              <div className="bg-white/20 p-2 rounded-full">
                <Trophy className="w-6 h-6" />
              </div>
              <div>
                <h4 className="font-bold text-lg">Achievement Unlocked!</h4>
                <p className="font-medium">{showAchievement.title}</p>
                <p className="text-xs opacity-90">{showAchievement.desc}</p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default QuestMap;