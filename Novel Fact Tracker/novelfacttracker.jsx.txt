import React, { useState, useEffect, useRef } from 'react';
import { 
  FileText, 
  Users, 
  Clock, 
  Zap, 
  Trash2, 
  Upload, 
  ShieldAlert, 
  ChevronRight, 
  Loader2,
  BookOpen,
  Info,
  Layers
} from 'lucide-react';

// --- CONFIGURATION ---
const apiKey = ""; // Environment provides this at runtime
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

const App = () => {
  const [chapters, setChapters] = useState([]);
  const [selectedChapterId, setSelectedChapterId] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [activeTab, setActiveTab] = useState('characters'); // 'characters', 'timeline', 'progression', 'powers'
  const [error, setError] = useState(null);

  // Global extraction state (compiled from all processed chapters)
  const [masterData, setMasterData] = useState({
    characters: [],
    timeline: [],
    progression: [],
    powerChanges: []
  });

  const fileInputRef = useRef(null);

  // --- API LOGIC ---
  const extractFacts = async (text, chapterTitle) => {
    const systemPrompt = `You are a strict factual extractor for novel manuscripts. 
    Your goal is to extract data with zero interpretation, zero inference, and zero literary analysis.
    
    RULES:
    1. Treat the text like a log file or a police report.
    2. Extract only what is EXPLICITLY written in the text.
    3. Never assume emotions, motivations, or subtext.
    4. If a character's status or trait isn't stated, use "Not specified in the text."
    5. No phrases like "This suggests," "Likely," or "The author implies."
    6. If it isn't in the text, it does not exist in your output.
    
    OUTPUT STRUCTURE (JSON):
    {
      "characters": [{"name": "Name", "traits": "Explicit traits only", "status": "Current status as written"}],
      "events": [{"time": "Specific time/order", "description": "Factual event description"}],
      "progression": "A factual summary of what occurred in this chapter",
      "powerChanges": [{"description": "Directly stated power/status change"}]
    }`;

    const userQuery = `Analyze Chapter "${chapterTitle}":\n\n${text}`;

    let retries = 0;
    const maxRetries = 5;
    
    while (retries <= maxRetries) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { 
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  characters: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        name: { type: "STRING" },
                        traits: { type: "STRING" },
                        status: { type: "STRING" }
                      }
                    }
                  },
                  events: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        time: { type: "STRING" },
                        description: { type: "STRING" }
                      }
                    }
                  },
                  progression: { type: "STRING" },
                  powerChanges: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        description: { type: "STRING" }
                      }
                    }
                  }
                }
              }
            }
          })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!rawText) throw new Error("Empty response from AI");
        return JSON.parse(rawText);
      } catch (err) {
        if (retries === maxRetries) throw err;
        const delay = Math.pow(2, retries) * 1000;
        await new Promise(res => setTimeout(res, delay));
        retries++;
      }
    }
  };

  const handleFileUpload = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = async (event) => {
        const newChapter = {
          id: Math.random().toString(36).substr(2, 9),
          title: file.name.replace('.txt', ''),
          content: event.target.result,
          processed: false,
          data: null
        };
        setChapters(prev => [...prev, newChapter]);
      };
      reader.readAsText(file);
    });
    e.target.value = null;
  };

  const processChapter = async (id) => {
    setIsProcessing(true);
    setError(null);
    try {
      const chapter = chapters.find(c => c.id === id);
      const data = await extractFacts(chapter.content, chapter.title);
      
      setChapters(prev => prev.map(c => 
        c.id === id ? { ...c, processed: true, data } : c
      ));
      
      updateMasterData(data);
    } catch (err) {
      console.error(err);
      setError("Failed to extract facts. Please check connection and try again.");
    } finally {
      setIsProcessing(false);
    }
  };

  const updateMasterData = (newData) => {
    if (!newData) return;

    setMasterData(prev => {
      const incomingCharacters = Array.isArray(newData.characters) ? newData.characters : [];
      const incomingEvents = Array.isArray(newData.events) ? newData.events : [];
      const incomingPowerChanges = Array.isArray(newData.powerChanges) ? newData.powerChanges : [];
      const incomingProgression = typeof newData.progression === 'string' ? newData.progression : "";

      const mergedChars = [...prev.characters];
      incomingCharacters.forEach(newChar => {
        if (!newChar.name) return;
        const existingIdx = mergedChars.findIndex(c => c.name.toLowerCase() === newChar.name.toLowerCase());
        if (existingIdx > -1) {
          // Update existing with most recent status
          mergedChars[existingIdx] = { ...mergedChars[existingIdx], ...newChar };
        } else {
          mergedChars.push(newChar);
        }
      });

      return {
        characters: mergedChars,
        timeline: [...prev.timeline, ...incomingEvents],
        progression: incomingProgression ? [...prev.progression, incomingProgression] : prev.progression,
        powerChanges: [...prev.powerChanges, ...incomingPowerChanges]
      };
    });
  };

  const removeChapter = (id) => {
    setChapters(prev => prev.filter(c => c.id !== id));
    if (selectedChapterId === id) setSelectedChapterId(null);
  };

  // Helper to get active data (either single chapter or master repo)
  const getActiveData = () => {
    if (selectedChapterId) {
      return chapters.find(c => c.id === selectedChapterId)?.data || {};
    }
    return masterData;
  };

  const currentData = getActiveData();

  return (
    <div className="min-h-screen bg-neutral-900 text-neutral-100 flex flex-col font-sans">
      <header className="border-b border-neutral-800 bg-neutral-900/50 backdrop-blur-md sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2 cursor-pointer" onClick={() => setSelectedChapterId(null)}>
            <div className="bg-indigo-600 p-2 rounded-lg">
              <BookOpen size={20} className="text-white" />
            </div>
            <h1 className="text-xl font-bold tracking-tight">FactTracker <span className="text-neutral-500 font-normal text-sm">MVP</span></h1>
          </div>
          <div className="flex items-center gap-4">
            <button 
              onClick={() => fileInputRef.current?.click()}
              className="flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg text-sm transition-all"
            >
              <Upload size={16} />
              Upload Chapters
            </button>
            <input 
              type="file" 
              ref={fileInputRef} 
              className="hidden" 
              multiple 
              accept=".txt" 
              onChange={handleFileUpload} 
            />
          </div>
        </div>
      </header>

      <main className="flex-1 max-w-7xl mx-auto w-full p-6 grid grid-cols-12 gap-6 overflow-hidden">
        {/* Left Sidebar */}
        <div className="col-span-3 flex flex-col gap-4 overflow-y-auto pr-2 custom-scrollbar">
          <button 
            onClick={() => setSelectedChapterId(null)}
            className={`w-full p-3 rounded-xl border flex items-center gap-3 transition-all ${
              selectedChapterId === null 
                ? 'bg-indigo-600/10 border-indigo-500/50 text-indigo-400' 
                : 'bg-neutral-800/30 border-transparent text-neutral-400 hover:bg-neutral-800'
            }`}
          >
            <Layers size={18} />
            <span className="text-sm font-bold">Global Repository</span>
          </button>

          <div className="flex items-center justify-between mt-4">
            <h2 className="text-xs font-semibold uppercase tracking-widest text-neutral-500">Chapters</h2>
            <span className="text-xs bg-neutral-800 px-2 py-0.5 rounded text-neutral-400">{chapters.length}</span>
          </div>
          
          {chapters.length === 0 ? (
            <div className="p-8 border-2 border-dashed border-neutral-800 rounded-xl text-center">
              <p className="text-sm text-neutral-600">No chapters yet.</p>
            </div>
          ) : (
            chapters.map((chapter) => (
              <div 
                key={chapter.id}
                onClick={() => setSelectedChapterId(chapter.id)}
                className={`group p-3 rounded-xl cursor-pointer border transition-all ${
                  selectedChapterId === chapter.id 
                    ? 'bg-indigo-600/10 border-indigo-500/50' 
                    : 'bg-neutral-800/50 border-transparent hover:border-neutral-700'
                }`}
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1 min-w-0">
                    <p className={`text-sm font-medium truncate ${selectedChapterId === chapter.id ? 'text-indigo-400' : 'text-neutral-200'}`}>
                      {chapter.title}
                    </p>
                    <div className="flex items-center gap-2 mt-1">
                      {chapter.processed ? (
                        <span className="text-[10px] text-green-500 flex items-center gap-1">
                          <div className="w-1 h-1 rounded-full bg-green-500" /> Extracted
                        </span>
                      ) : (
                        <span className="text-[10px] text-amber-500 flex items-center gap-1">
                          <div className="w-1 h-1 rounded-full bg-amber-500 animate-pulse" /> Ready
                        </span>
                      )}
                    </div>
                  </div>
                  <button 
                    onClick={(e) => { e.stopPropagation(); removeChapter(chapter.id); }}
                    className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 transition-opacity"
                  >
                    <Trash2 size={14} />
                  </button>
                </div>
                {!chapter.processed && (
                  <button 
                    onClick={(e) => { e.stopPropagation(); processChapter(chapter.id); }}
                    disabled={isProcessing}
                    className="mt-3 w-full py-1.5 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-[11px] font-bold rounded flex items-center justify-center gap-1"
                  >
                    {isProcessing ? <Loader2 size={12} className="animate-spin" /> : "Extract"}
                  </button>
                )}
              </div>
            ))
          )}
        </div>

        {/* Content View */}
        <div className="col-span-9 flex flex-col gap-6 bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6 overflow-hidden">
          {error && (
            <div className="bg-red-950/50 border border-red-500/50 p-4 rounded-xl flex items-center gap-3 text-red-200 text-sm">
              <ShieldAlert size={18} />
              {error}
            </div>
          )}

          {chapters.length === 0 ? (
            <div className="flex-1 flex flex-col items-center justify-center text-center">
              <div className="w-16 h-16 bg-neutral-800 rounded-2xl flex items-center justify-center mb-4 text-neutral-600">
                <FileText size={32} />
              </div>
              <h3 className="text-xl font-bold">Upload Your Manuscript</h3>
              <p className="text-neutral-500 max-w-sm mt-2">
                This tool extracts facts only. No interpretation, no fluff. Upload .txt files to start your tracker.
              </p>
            </div>
          ) : (
            <>
              {/* Header for View */}
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold">
                    {selectedChapterId ? chapters.find(c => c.id === selectedChapterId)?.title : "Global Repository"}
                  </h2>
                  <p className="text-sm text-neutral-500 mt-1">
                    {selectedChapterId ? "Factual extraction for this chapter." : "Aggregated data from all processed chapters."}
                  </p>
                </div>
                <div className="flex gap-1 bg-neutral-950 p-1 rounded-xl">
                  {[
                    { id: 'characters', icon: Users, label: 'Characters' },
                    { id: 'timeline', icon: Clock, label: 'Timeline' },
                    { id: 'progression', icon: ChevronRight, label: 'Plot' },
                    { id: 'powers', icon: Zap, label: 'Status' }
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                        activeTab === tab.id 
                          ? 'bg-neutral-800 text-white shadow-sm' 
                          : 'text-neutral-500 hover:text-neutral-300'
                      }`}
                    >
                      <tab.icon size={16} />
                      <span className="hidden md:inline">{tab.label}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* Data Display */}
              <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                {activeTab === 'characters' && (
                  <div className="grid grid-cols-2 gap-4">
                    {(currentData.characters || []).map((char, i) => (
                      <div key={i} className="bg-neutral-800/40 border border-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold text-indigo-400">{char.name || "Unknown"}</h4>
                        <div className="mt-3 space-y-2">
                          <p className="text-xs">
                            <span className="text-neutral-500 block uppercase tracking-tighter mb-0.5">Traits</span> 
                            {char.traits || "Not specified."}
                          </p>
                          <p className="text-xs">
                            <span className="text-neutral-500 block uppercase tracking-tighter mb-0.5">Status</span> 
                            <span className={(char.status || "").toLowerCase().includes('dead') ? 'text-red-400' : 'text-green-400'}>
                              {char.status || "Not specified."}
                            </span>
                          </p>
                        </div>
                      </div>
                    ))}
                    {(!currentData.characters || currentData.characters.length === 0) && (
                      <div className="col-span-2 text-center py-20 bg-neutral-800/20 rounded-2xl border border-dashed border-neutral-800">
                        <Users className="mx-auto mb-2 text-neutral-700" size={32} />
                        <p className="text-neutral-600 text-sm">No characters extracted yet.</p>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'timeline' && (
                  <div className="space-y-4">
                    {(currentData.timeline || []).map((event, i) => (
                      <div key={i} className="flex gap-4 relative">
                        <div className="w-12 text-[10px] text-neutral-600 font-mono pt-1 text-right shrink-0">
                          {event.time || `E-${i+1}`}
                        </div>
                        <div className="w-px bg-neutral-800 relative shrink-0">
                          <div className="absolute top-2 -left-1 w-2 h-2 rounded-full bg-neutral-700" />
                        </div>
                        <div className="flex-1 pb-6">
                          <p className="text-sm text-neutral-300 leading-relaxed">{event.description}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {activeTab === 'progression' && (
                  <div className="space-y-4">
                    {selectedChapterId ? (
                      <div className="bg-neutral-800/30 p-6 rounded-2xl border border-neutral-800">
                        <p className="text-sm text-neutral-300 leading-relaxed">
                          {currentData.progression || "No factual summary for this chapter."}
                        </p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {masterData.progression.map((sum, idx) => (
                          <div key={idx} className="bg-neutral-800/30 p-4 rounded-xl border border-neutral-800">
                            <h5 className="text-[10px] uppercase tracking-widest text-neutral-600 mb-2">Chapter {idx+1} Update</h5>
                            <p className="text-sm text-neutral-300">{sum}</p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'powers' && (
                  <div className="space-y-3">
                    {(currentData.powerChanges || []).map((pc, i) => (
                      <div key={i} className="flex items-center gap-3 bg-amber-900/10 border border-amber-900/30 p-3 rounded-lg text-amber-200/80">
                        <Zap size={16} className="text-amber-500 shrink-0" />
                        <span className="text-sm">{pc.description}</span>
                      </div>
                    ))}
                    {(!currentData.powerChanges || currentData.powerChanges.length === 0) && (
                      <p className="text-center text-neutral-600 py-10">No significant status changes identified.</p>
                    )}
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      </main>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #444; }
      `}</style>
    </div>
  );
};

export default App;